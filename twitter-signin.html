<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Shake that egg!</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="440901775384-u6ccttfi7do991mnolnlf6g8ut8qm65t.apps.googleusercontent.com">
   
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>

    <script src="https://apis.google.com/js/platform.js" async defer></script>
    
    </head>
  <body>

    <button onclick="signIn()">Sign in</button>
    <a href="#" onclick="signOut()">Sign out</a>
    <button onclick="addEgg('L', 3)">Add egg</button>
    <button onclick="getEggTime('S', 5)">Get time</button>



    <script>    
    var ref = new Firebase("https://eggapp.firebaseio.com");
    var allEggs = ref.child('eggbase');
    var allUsers = ref.child('userbase');
    var allVideos = ref.child('videobase');

    var loggedIn
    var time

    function authDataCallback(authData) {
      if (authData) {
        console.log("User " + authData.uid + " is logged in with " + authData.provider);
        addUser(authData);
      } else {
          console.log("User is logged out");
      }
    };
    
    ref.onAuth(authDataCallback);

    function signIn(){
    ref.authWithOAuthRedirect("google", function(error) {
      if (error) {
        console.log("Login Failed!", error);
        return
        } else{ 
        }
      });
    };

    function signOut(){
      ref.unauth();
    };

    function addUser(authData){
    var a = false; 
    allUsers.once("value", function(snapshot) {
    // The callback function will get called twice, once for "fred" and once for "barney"
      snapshot.forEach(function(childSnapshot) {
    // key will be "fred" the first time and "barney" the second time
      if(childSnapshot.val().uid === authData.uid){
        console.log("Inloggat id finns i databasen");
        console.log("Då är vi klara här! Return true");
        loggedIn = allUsers.child(childSnapshot.key())
        a = true;
        return true;         
      }else{
        console.log("Inloggat id finns inte databasen")
        console.log("Kollar nästa id i databasen")
      }
      });
      if(a === false){
      console.log("Inloggat id fanns inte i databasen. Lägger till användaren") 
      var newUser = allUsers.push({'uid': authData.uid, 'name': authData.google.displayName, 'egg': "No eggs"});
      console.log(newUser.key())
      loggedIn = new Firebase("https://eggapp.firebaseio.com/userbase/"+newUser.key());
      };
    });
  };

    function addEgg(size, boil){
      loggedIn.once("value", function(snapshot){
        if(snapshot.child('egg').val() === "No eggs"){
          console.log("No eggs")
          loggedIn.child('egg').push({'size': size, 'boil': boil})
        } else{ 
          loggedIn.child('egg').push({'size': size, 'boil': boil})
          console.log(size, boil)
        }
      });
    }

    function getEggTime(size, boil){
      allEggsSize = allEggs.child(size)
      allEggsSize.once("value", function(snapshot){
        snapshot.forEach(function(childSnapshot) {
          if(childSnapshot.key() == boil){
            console.log('if', boil, childSnapshot.key())
            time = childSnapshot.val();
          }else{
            console.log('else', boil, childSnapshot.key())
          }
        });
      }); 
    };



    </script>
  </body>
</html>
